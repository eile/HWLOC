\hypertarget{a00028_source}{
\section{cuda.h}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright © 2010-2012 inria.  All rights reserved.}
00003 \textcolor{comment}{ * Copyright © 2010-2011 Université Bordeaux 1}
00004 \textcolor{comment}{ * Copyright © 2011 Cisco Systems, Inc.  All rights reserved.}
00005 \textcolor{comment}{ * See COPYING in top-level directory.}
00006 \textcolor{comment}{ */}
00007 
00016 \textcolor{preprocessor}{#ifndef HWLOC\_CUDA\_H}
00017 \textcolor{preprocessor}{}\textcolor{preprocessor}{#define HWLOC\_CUDA\_H}
00018 \textcolor{preprocessor}{}
00019 \textcolor{preprocessor}{#include <hwloc.h>}
00020 \textcolor{preprocessor}{#include <hwloc/autogen/config.h>}
00021 \textcolor{preprocessor}{#include <hwloc/linux.h>}
00022 \textcolor{preprocessor}{#include <hwloc/helper.h>}
00023 
00024 \textcolor{preprocessor}{#include <cuda.h>}
00025 
00026 
00027 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00028 \textcolor{preprocessor}{}\textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \{
00029 \textcolor{preprocessor}{#endif}
00030 \textcolor{preprocessor}{}
00031 
00038 \textcolor{keyword}{static} \_\_hwloc\_inline \textcolor{keywordtype}{int}
\hypertarget{a00028_source_l00039}{}\hyperlink{a00070_gae45c92fbc7ac538cf69fdfcc73994ed9}{00039} \hyperlink{a00070_gae45c92fbc7ac538cf69fdfcc73994ed9}{hwloc_cuda_get_device_pci_ids}(\hyperlink{a00039_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc_topology_t} topology \_\_hwloc\_attribute\_unused,
      
00040                                CUdevice cudevice, \textcolor{keywordtype}{int} *domain, \textcolor{keywordtype}{int} *bus, \textcolor{keywordtype}{int} *dev
      )
00041 \{
00042   CUresult cres;
00043 
00044 \textcolor{preprocessor}{#if CUDA\_VERSION >= 4000}
00045 \textcolor{preprocessor}{}  cres = cuDeviceGetAttribute(domain, CU\_DEVICE\_ATTRIBUTE\_PCI\_DOMAIN\_ID, cudevice
      );
00046   \textcolor{keywordflow}{if} (cres != CUDA\_SUCCESS) \{
00047     errno = ENOSYS;
00048     \textcolor{keywordflow}{return} -1;
00049   \}
00050 \textcolor{preprocessor}{#else}
00051 \textcolor{preprocessor}{}  *domain = 0;
00052 \textcolor{preprocessor}{#endif}
00053 \textcolor{preprocessor}{}  cres = cuDeviceGetAttribute(bus, CU\_DEVICE\_ATTRIBUTE\_PCI\_BUS\_ID, cudevice);
00054   \textcolor{keywordflow}{if} (cres != CUDA\_SUCCESS) \{
00055     errno = ENOSYS;
00056     \textcolor{keywordflow}{return} -1;
00057   \}
00058   cres = cuDeviceGetAttribute(dev, CU\_DEVICE\_ATTRIBUTE\_PCI\_DEVICE\_ID, cudevice);
00059   \textcolor{keywordflow}{if} (cres != CUDA\_SUCCESS) \{
00060     errno = ENOSYS;
00061     \textcolor{keywordflow}{return} -1;
00062   \}
00063 
00064   \textcolor{keywordflow}{return} 0;
00065 \}
00066 
00077 \textcolor{keyword}{static} \_\_hwloc\_inline \textcolor{keywordtype}{int}
\hypertarget{a00028_source_l00078}{}\hyperlink{a00070_gae06cf330d2f0d9949feb52b146b7d136}{00078} \hyperlink{a00070_gae06cf330d2f0d9949feb52b146b7d136}{hwloc_cuda_get_device_cpuset}(\hyperlink{a00039_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc_topology_t} topology \_\_hwloc\_attribute\_unused,
00079                              CUdevice cudevice, \hyperlink{a00040_ga4bbf39b68b6f568fb92739e7c0ea7801}{hwloc_cpuset_t} \textcolor{keyword}{set})
00080 \{
00081 \textcolor{preprocessor}{#ifdef HWLOC\_LINUX\_SYS}
00082 \textcolor{preprocessor}{}  \textcolor{comment}{/* If we're on Linux, use the sysfs mechanism to get the local cpus */}
00083 \textcolor{preprocessor}{#define HWLOC\_CUDA\_DEVICE\_SYSFS\_PATH\_MAX 128}
00084 \textcolor{preprocessor}{}  \textcolor{keywordtype}{char} path[HWLOC\_CUDA\_DEVICE\_SYSFS\_PATH\_MAX];
00085   FILE *sysfile = NULL;
00086   \textcolor{keywordtype}{int} domainid, busid, deviceid;
00087 
00088   \textcolor{keywordflow}{if} (\hyperlink{a00070_gae45c92fbc7ac538cf69fdfcc73994ed9}{hwloc_cuda_get_device_pci_ids}(topology, cudevice, &domainid, &busid, &devic
      eid))
00089     \textcolor{keywordflow}{return} -1;
00090 
00091   \textcolor{keywordflow}{if} (!\hyperlink{a00046_ga0d109e33fc7990f62f665d336e5e5111}{hwloc_topology_is_thissystem}(topology)) \{
00092     errno = EINVAL;
00093     \textcolor{keywordflow}{return} -1;
00094   \}
00095 
00096   sprintf(path, \textcolor{stringliteral}{"/sys/bus/pci/devices/%04x:%02x:%02x.0/local\_cpus"}, domainid, bus
      id, deviceid);
00097   sysfile = fopen(path, \textcolor{stringliteral}{"r"});
00098   \textcolor{keywordflow}{if} (!sysfile)
00099     \textcolor{keywordflow}{return} -1;
00100 
00101   \hyperlink{a00067_gaeacad897c30dbea284948374ad4b010c}{hwloc_linux_parse_cpumap_file}(sysfile, \textcolor{keyword}{set});
00102   \textcolor{keywordflow}{if} (\hyperlink{a00065_gaa94fed35d2a598bc4a8657b6955b7bf5}{hwloc_bitmap_iszero}(\textcolor{keyword}{set}))
00103     \hyperlink{a00065_gab14743355fa03b36cef521cbcd2fbf64}{hwloc_bitmap_copy}(\textcolor{keyword}{set}, \hyperlink{a00060_ga418ebb39eaf1eac8f9cf4047cf59a534}{hwloc_topology_get_complete_cpuset}(topology));
00104 
00105   fclose(sysfile);
00106 \textcolor{preprocessor}{#else}
00107 \textcolor{preprocessor}{}  \textcolor{comment}{/* Non-Linux systems simply get a full cpuset */}
00108   \hyperlink{a00065_gab14743355fa03b36cef521cbcd2fbf64}{hwloc_bitmap_copy}(\textcolor{keyword}{set}, \hyperlink{a00060_ga418ebb39eaf1eac8f9cf4047cf59a534}{hwloc_topology_get_complete_cpuset}(topology));
00109 \textcolor{preprocessor}{#endif}
00110 \textcolor{preprocessor}{}  \textcolor{keywordflow}{return} 0;
00111 \}
00112 
00121 \textcolor{keyword}{static} \_\_hwloc\_inline \hyperlink{a00016}{hwloc_obj_t}
\hypertarget{a00028_source_l00122}{}\hyperlink{a00070_ga04d1f8bd566a7f0b30d5e498f9228042}{00122} \hyperlink{a00070_ga04d1f8bd566a7f0b30d5e498f9228042}{hwloc_cuda_get_device_pcidev}(\hyperlink{a00039_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc_topology_t} topology, CUdevice cudevice)
00123 \{
00124   \textcolor{keywordtype}{int} domain, bus, dev;
00125 
00126   \textcolor{keywordflow}{if} (\hyperlink{a00070_gae45c92fbc7ac538cf69fdfcc73994ed9}{hwloc_cuda_get_device_pci_ids}(topology, cudevice, &domain, &bus, &dev))
00127     \textcolor{keywordflow}{return} NULL;
00128 
00129   \textcolor{keywordflow}{return} \hyperlink{a00064_ga546e1d690c63fb24177f3013ed78ceb1}{hwloc_get_pcidev_by_busid}(topology, domain, bus, dev, 0);
00130 \}
00131 
00135 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00136 \textcolor{preprocessor}{}\} \textcolor{comment}{/* extern "C" */}
00137 \textcolor{preprocessor}{#endif}
00138 \textcolor{preprocessor}{}
00139 
00140 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* HWLOC\_CUDA\_H */}
\end{DoxyCode}
