\hypertarget{a00037_source}{
\section{openfabrics-\/verbs.h}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright © 2009 CNRS}
00003 \textcolor{comment}{ * Copyright © 2009-2010 inria.  All rights reserved.}
00004 \textcolor{comment}{ * Copyright © 2009-2010 Université Bordeaux 1}
00005 \textcolor{comment}{ * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.}
00006 \textcolor{comment}{ * See COPYING in top-level directory.}
00007 \textcolor{comment}{ */}
00008 
00019 \textcolor{preprocessor}{#ifndef HWLOC\_OPENFABRICS\_VERBS\_H}
00020 \textcolor{preprocessor}{}\textcolor{preprocessor}{#define HWLOC\_OPENFABRICS\_VERBS\_H}
00021 \textcolor{preprocessor}{}
00022 \textcolor{preprocessor}{#include <hwloc.h>}
00023 \textcolor{preprocessor}{#include <hwloc/autogen/config.h>}
00024 \textcolor{preprocessor}{#include <hwloc/linux.h>}
00025 
00026 \textcolor{preprocessor}{#include <infiniband/verbs.h>}
00027 
00028 
00029 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00030 \textcolor{preprocessor}{}\textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \{
00031 \textcolor{preprocessor}{#endif}
00032 \textcolor{preprocessor}{}
00033 
00046 \textcolor{keyword}{static} \_\_hwloc\_inline \textcolor{keywordtype}{int}
\hypertarget{a00037_source_l00047}{}\hyperlink{a00073_gaa8ea979ce3a9b8c70ae80bc5716a0fbe}{00047} \hyperlink{a00073_gaa8ea979ce3a9b8c70ae80bc5716a0fbe}{hwloc_ibv_get_device_cpuset}(\hyperlink{a00039_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc_topology_t} topology \_\_hwloc\_attribute\_unused,
00048                             \textcolor{keyword}{struct} ibv\_device *ibdev, \hyperlink{a00040_ga4bbf39b68b6f568fb92739e7c0ea7801}{hwloc_cpuset_t} \textcolor{keyword}{set})
00049 \{
00050 \textcolor{preprocessor}{#ifdef HWLOC\_LINUX\_SYS}
00051 \textcolor{preprocessor}{}  \textcolor{comment}{/* If we're on Linux, use the verbs-provided sysfs mechanism to}
00052 \textcolor{comment}{     get the local cpus */}
00053 \textcolor{preprocessor}{#define HWLOC\_OPENFABRICS\_VERBS\_SYSFS\_PATH\_MAX 128}
00054 \textcolor{preprocessor}{}  \textcolor{keywordtype}{char} path[HWLOC\_OPENFABRICS\_VERBS\_SYSFS\_PATH\_MAX];
00055   FILE *sysfile = NULL;
00056 
00057   sprintf(path, \textcolor{stringliteral}{"/sys/class/infiniband/%s/device/local\_cpus"},
00058           ibv\_get\_device\_name(ibdev));
00059   sysfile = fopen(path, \textcolor{stringliteral}{"r"});
00060   \textcolor{keywordflow}{if} (!sysfile)
00061     \textcolor{keywordflow}{return} -1;
00062 
00063   \hyperlink{a00067_gaeacad897c30dbea284948374ad4b010c}{hwloc_linux_parse_cpumap_file}(sysfile, \textcolor{keyword}{set});
00064   \textcolor{keywordflow}{if} (\hyperlink{a00065_gaa94fed35d2a598bc4a8657b6955b7bf5}{hwloc_bitmap_iszero}(\textcolor{keyword}{set}))
00065     \hyperlink{a00065_gab14743355fa03b36cef521cbcd2fbf64}{hwloc_bitmap_copy}(\textcolor{keyword}{set}, \hyperlink{a00060_ga418ebb39eaf1eac8f9cf4047cf59a534}{hwloc_topology_get_complete_cpuset}(topology));
00066 
00067   fclose(sysfile);
00068 \textcolor{preprocessor}{#else}
00069 \textcolor{preprocessor}{}  \textcolor{comment}{/* Non-Linux systems simply get a full cpuset */}
00070   \hyperlink{a00065_gab14743355fa03b36cef521cbcd2fbf64}{hwloc_bitmap_copy}(\textcolor{keyword}{set}, \hyperlink{a00060_ga418ebb39eaf1eac8f9cf4047cf59a534}{hwloc_topology_get_complete_cpuset}(topology));
00071 \textcolor{preprocessor}{#endif}
00072 \textcolor{preprocessor}{}  \textcolor{keywordflow}{return} 0;
00073 \}
00074 
00078 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00079 \textcolor{preprocessor}{}\} \textcolor{comment}{/* extern "C" */}
00080 \textcolor{preprocessor}{#endif}
00081 \textcolor{preprocessor}{}
00082 
00083 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* HWLOC\_OPENFABRICS\_VERBS\_H */}
\end{DoxyCode}
