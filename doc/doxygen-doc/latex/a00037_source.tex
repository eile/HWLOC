\hypertarget{a00037_source}{
\section{openfabrics-\/verbs.h}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright © 2009 CNRS}
00003 \textcolor{comment}{ * Copyright © 2009-2012 inria.  All rights reserved.}
00004 \textcolor{comment}{ * Copyright © 2009-2010 Université Bordeaux 1}
00005 \textcolor{comment}{ * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.}
00006 \textcolor{comment}{ * See COPYING in top-level directory.}
00007 \textcolor{comment}{ */}
00008 
00019 \textcolor{preprocessor}{#ifndef HWLOC\_OPENFABRICS\_VERBS\_H}
00020 \textcolor{preprocessor}{}\textcolor{preprocessor}{#define HWLOC\_OPENFABRICS\_VERBS\_H}
00021 \textcolor{preprocessor}{}
00022 \textcolor{preprocessor}{#include <hwloc.h>}
00023 \textcolor{preprocessor}{#include <hwloc/autogen/config.h>}
00024 \textcolor{preprocessor}{#include <hwloc/linux.h>}
00025 
00026 \textcolor{preprocessor}{#include <infiniband/verbs.h>}
00027 
00028 
00029 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00030 \textcolor{preprocessor}{}\textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \{
00031 \textcolor{preprocessor}{#endif}
00032 \textcolor{preprocessor}{}
00033 
00048 \textcolor{keyword}{static} \_\_hwloc\_inline \textcolor{keywordtype}{int}
\hypertarget{a00037_source_l00049}{}\hyperlink{a00072_gaa8ea979ce3a9b8c70ae80bc5716a0fbe}{00049} \hyperlink{a00072_gaa8ea979ce3a9b8c70ae80bc5716a0fbe}{hwloc_ibv_get_device_cpuset}(\hyperlink{a00039_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc_topology_t} topology \_\_hwloc\_attribute\_unused,
00050                             \textcolor{keyword}{struct} ibv\_device *ibdev, \hyperlink{a00040_ga4bbf39b68b6f568fb92739e7c0ea7801}{hwloc_cpuset_t} \textcolor{keyword}{set})
00051 \{
00052 \textcolor{preprocessor}{#ifdef HWLOC\_LINUX\_SYS}
00053 \textcolor{preprocessor}{}  \textcolor{comment}{/* If we're on Linux, use the verbs-provided sysfs mechanism to}
00054 \textcolor{comment}{     get the local cpus */}
00055 \textcolor{preprocessor}{#define HWLOC\_OPENFABRICS\_VERBS\_SYSFS\_PATH\_MAX 128}
00056 \textcolor{preprocessor}{}  \textcolor{keywordtype}{char} path[HWLOC\_OPENFABRICS\_VERBS\_SYSFS\_PATH\_MAX];
00057   FILE *sysfile = NULL;
00058 
00059   \textcolor{keywordflow}{if} (!\hyperlink{a00046_ga0d109e33fc7990f62f665d336e5e5111}{hwloc_topology_is_thissystem}(topology)) \{
00060     errno = EINVAL;
00061     \textcolor{keywordflow}{return} -1;
00062   \}
00063 
00064   sprintf(path, \textcolor{stringliteral}{"/sys/class/infiniband/%s/device/local\_cpus"},
00065           ibv\_get\_device\_name(ibdev));
00066   sysfile = fopen(path, \textcolor{stringliteral}{"r"});
00067   \textcolor{keywordflow}{if} (!sysfile)
00068     \textcolor{keywordflow}{return} -1;
00069 
00070   \hyperlink{a00067_gaeacad897c30dbea284948374ad4b010c}{hwloc_linux_parse_cpumap_file}(sysfile, \textcolor{keyword}{set});
00071   \textcolor{keywordflow}{if} (\hyperlink{a00065_gaa94fed35d2a598bc4a8657b6955b7bf5}{hwloc_bitmap_iszero}(\textcolor{keyword}{set}))
00072     \hyperlink{a00065_gab14743355fa03b36cef521cbcd2fbf64}{hwloc_bitmap_copy}(\textcolor{keyword}{set}, \hyperlink{a00060_ga418ebb39eaf1eac8f9cf4047cf59a534}{hwloc_topology_get_complete_cpuset}(topology));
00073 
00074   fclose(sysfile);
00075 \textcolor{preprocessor}{#else}
00076 \textcolor{preprocessor}{}  \textcolor{comment}{/* Non-Linux systems simply get a full cpuset */}
00077   \hyperlink{a00065_gab14743355fa03b36cef521cbcd2fbf64}{hwloc_bitmap_copy}(\textcolor{keyword}{set}, \hyperlink{a00060_ga418ebb39eaf1eac8f9cf4047cf59a534}{hwloc_topology_get_complete_cpuset}(topology));
00078 \textcolor{preprocessor}{#endif}
00079 \textcolor{preprocessor}{}  \textcolor{keywordflow}{return} 0;
00080 \}
00081 
00098 \textcolor{keyword}{static} \_\_hwloc\_inline \hyperlink{a00016}{hwloc_obj_t}
\hypertarget{a00037_source_l00099}{}\hyperlink{a00072_gaa6139e8ce1279bd91867b31b9ff4316b}{00099} \hyperlink{a00072_gaa6139e8ce1279bd91867b31b9ff4316b}{hwloc_ibv_get_device_osdev_by_name}(\hyperlink{a00039_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc_topology_t} topology,
00100                                    \textcolor{keyword}{const} \textcolor{keywordtype}{char} *ibname)
00101 \{
00102         \hyperlink{a00016}{hwloc_obj_t} osdev = NULL;
00103         \textcolor{keywordflow}{while} ((osdev = \hyperlink{a00064_ga73a5bc6265642e6001f7a10812ab886d}{hwloc_get_next_osdev}(topology, osdev)) != NULL) \{
00104                 \textcolor{keywordflow}{if} (\hyperlink{a00041_gga64f5d539df299c97ae80ce53fc4b56c0a52157d03694fdae82dddd57ca8c973b6}{HWLOC_OBJ_OSDEV_OPENFABRICS} == osdev->\hyperlink{a00016_accd40e29f71f19e88db62ea3df02adc8}{attr}->\hyperlink{a00017_a22904c25fe44b323bab5c9bc52660fca}{osdev}.\hyperlink{a00021_a31e019e27e54ac6138d04be639bb96f9}{type}
00105                     && osdev->\hyperlink{a00016_abb709ec38f2970677e4e57d1d30be96d}{name} && !strcmp(ibname, osdev->\hyperlink{a00016_abb709ec38f2970677e4e57d1d30be96d}{name}))
00106                         \textcolor{keywordflow}{return} osdev;
00107         \}
00108         \textcolor{keywordflow}{return} NULL;
00109 \}
00110 
00114 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00115 \textcolor{preprocessor}{}\} \textcolor{comment}{/* extern "C" */}
00116 \textcolor{preprocessor}{#endif}
00117 \textcolor{preprocessor}{}
00118 
00119 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* HWLOC\_OPENFABRICS\_VERBS\_H */}
\end{DoxyCode}
